<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø±ÙˆÙ… ØµÙˆØªÙŠ â€“ Ø´Ø§Øª Ø£Ø¨Ùˆ Ø£Ù…ÙŠØ± (Cyberpunk)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Tahoma, sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at 10% 10%, #ff00ea33 0, transparent 60%),
        radial-gradient(circle at 90% 0, #00e5ff33 0, transparent 55%),
        radial-gradient(circle at 0 100%, #00ff9d22 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #ff910022 0, transparent 55%),
        #050816;
      color: #e5f0ff;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .room-shell {
      width: 100%;
      max-width: 520px;
      margin: auto;
      background: linear-gradient(135deg, #050816dd, #020617ee);
      border-radius: 28px;
      padding: 14px;
      position: relative;
      overflow: hidden;
      box-shadow:
        0 0 0 1px #22d3ee33,
        0 25px 60px #000000cc;
      backdrop-filter: blur(20px);
      border: 1px solid #1e293b;
    }

    .room-shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        conic-gradient(from 200deg,
          #22d3ee22,
          #a855f733,
          #22c55e22,
          #f9731622,
          #22d3ee22);
      opacity: 0.55;
      filter: blur(40px);
      animation: spinGlow 22s linear infinite;
      z-index: -1;
    }

    @keyframes spinGlow {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .room-inner {
      border-radius: 24px;
      padding: 16px 14px 18px;
      background: radial-gradient(circle at top left, #1e293b88 0, transparent 55%),
                  radial-gradient(circle at bottom right, #020617dd 0, #020617ee 55%);
      position: relative;
      overflow: hidden;
    }

    .room-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 18px;
      background: linear-gradient(135deg, #020617dd, #020617ee);
      border: 1px solid #1f2937;
      box-shadow: 0 0 20px #0ea5e933;
      margin-bottom: 14px;
    }

    .room-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .room-title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.03em;
    }

    .room-sub {
      font-size: 12px;
      color: #9ca3af;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at 10% 0, #22c55ecc 0, #16a34a88 35%, #166534 75%);
      color: #ecfdf5;
      box-shadow: 0 0 18px #22c55e55;
      border: 1px solid #bbf7d0;
      white-space: nowrap;
    }

    .pill-dot {
      width: 8px; height: 8px;
      border-radius: 999px;
      background: #bbf7d0;
      box-shadow: 0 0 12px #bbf7d0;
    }

    .back-btn {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at 30% 0%, #22d3ee44 0, #020617ff 45%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #e5e7eb;
      box-shadow: 0 10px 25px #000000aa;
    }

    .mics-block {
      margin-top: 6px;
      padding: 12px 10px 14px;
      background: radial-gradient(circle at 10% 0%, #4c1d9560 0, #020617fa 55%);
      border-radius: 22px;
      border: 1px solid #312e81;
      box-shadow: 0 0 0 1px #4c1d95aa,
                  0 18px 40px #000000dd;
    }

    .mics-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
      color: #9ca3af;
    }

    .mics-label {
      font-weight: 600;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mics-label i {
      color: #22c55e;
      text-shadow: 0 0 10px #22c55e;
    }

    .mics-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 10px;
    }

    .mic-slot {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }

    .mic-circle {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 30% 0%, #0f172a, #020617);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      cursor: pointer;
      box-shadow:
        0 0 0 1px #22d3ee55,
        0 0 18px #22d3ee55;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
    }

    .mic-circle::before {
      content: "";
      position: absolute;
      inset: -3px;
      border-radius: inherit;
      background:
        radial-gradient(circle at 30% 0, #22d3eecc, transparent 60%),
        radial-gradient(circle at 70% 90%, #a855f7aa, transparent 60%);
      opacity: 0.8;
      z-index: -1;
    }

    .mic-circle span {
      font-size: 22px;
      text-shadow: 0 0 12px #22d3eeaa;
    }

    .mic-name {
      color: #e5e7eb;
    }

    .mic-circle.mic-active {
      background: radial-gradient(circle at 30% 0%, #22c55e, #166534);
      box-shadow:
        0 0 0 1px #bbf7d0,
        0 0 20px #22c55ecc,
        0 0 35px #22c55e99;
    }

    .mic-circle.mic-muted {
      background: radial-gradient(circle at 30% 0%, #991b1b, #450a0a);
      box-shadow:
        0 0 0 1px #fecaca,
        0 0 17px #ef4444aa;
    }

    .mic-circle.mic-disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }

    .main-columns {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 14px;
    }

    .panel {
      background: radial-gradient(circle at 0 0, #0f172acc 0, #020617f5 60%);
      border-radius: 20px;
      border: 1px solid #1f2937;
      padding: 10px 10px 12px;
      box-shadow: 0 12px 30px #000000cc;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .panel-header span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .panel-header i {
      color: #22d3ee;
    }

    .chat-messages {
      max-height: 210px;
      min-height: 120px;
      overflow-y: auto;
      border-radius: 14px;
      padding: 6px 4px;
      background: #020617ee;
      border: 1px solid #111827;
      font-size: 12px;
      scrollbar-width: thin;
      scrollbar-color: #22d3ee44 transparent;
    }

    .chat-row {
      margin-bottom: 4px;
      padding: 4px 6px;
      border-radius: 8px;
      background: #020617;
    }

    .chat-meta {
      font-size: 10px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .chat-meta strong {
      color: #e5e7eb;
    }

    .chat-text {
      font-size: 12px;
      color: #e5e7eb;
      word-wrap: break-word;
    }

    .chat-input-row {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-input-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px 12px;
      color: #e5e7eb;
      font-size: 12px;
      outline: none;
    }

    .chat-input-row input::placeholder {
      color: #6b7280;
    }

    .send-btn {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 30% 0, #22d3ee, #0f766e);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: 0 0 20px #22d3eeaa;
      cursor: pointer;
    }

    .participants-list {
      max-height: 120px;
      overflow-y: auto;
      border-radius: 14px;
      padding: 6px;
      background: #020617ee;
      border: 1px solid #111827;
      font-size: 12px;
    }

    .participant-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px;
      border-radius: 10px;
      background: #020617;
      margin-bottom: 4px;
    }

    .participant-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #22c55e1a;
      color: #bbf7d0;
      border: 1px solid #22c55e55;
    }

    .call-panel {
      margin-top: 14px;
      padding: 10px 8px 4px;
      border-radius: 20px;
      background: radial-gradient(circle at 0 0, #1d1b4b, #020617);
      border: 1px solid #312e81;
      box-shadow: 0 14px 30px #000000cc;
      font-size: 12px;
    }

    .call-steps-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .call-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin: 4px 0;
    }

    .call-row span.step-label {
      min-width: 150px;
      color: #9ca3af;
    }

    .btn-sm {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-mic {
      background: radial-gradient(circle at 30% 0, #22c55e, #0f766e);
      color: white;
      box-shadow: 0 0 18px #22c55eaa;
    }

    .btn-create {
      background: radial-gradient(circle at 30% 0, #22d3ee, #0ea5e9);
      color: white;
      box-shadow: 0 0 18px #22d3eeaa;
    }

    .btn-join {
      background: radial-gradient(circle at 30% 0, #a855f7, #7c3aed);
      color: white;
      box-shadow: 0 0 18px #a855f7aa;
    }

    .btn-hang {
      background: radial-gradient(circle at 30% 0, #ef4444, #b91c1c);
      color: white;
      box-shadow: 0 0 18px #ef4444aa;
    }

    .hint-ok {
      color: #bbf7d0;
      font-size: 11px;
    }

    .log-title {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }

    .log-box {
      width: 100%;
      height: 110px;
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid #0f172a;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
      padding: 6px;
      resize: none;
      direction: ltr;
      white-space: pre-wrap;
    }

    .room-id-pill {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .room-id-pill code {
      background: #020617;
      border-radius: 999px;
      padding: 3px 9px;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      direction: ltr;
      font-size: 11px;
    }

    audio {
      width: 100%;
      margin-top: 6px;
    }

    @media (max-width: 480px) {
      .room-shell {
        padding: 10px;
        border-radius: 24px;
      }
      .room-inner {
        padding: 12px 10px 14px;
        border-radius: 20px;
      }
    }
  </style>
</head>
<body>

<div class="room-shell">
  <div class="room-inner">
    <!-- Ø±Ø£Ø³ Ø§Ù„Ø±ÙˆÙ… -->
    <div class="room-header">
      <button class="back-btn" onclick="goBackToMain()">
        <i class="fa-solid fa-arrow-right"></i>
      </button>

      <div class="room-title-block">
        <div id="roomTitle" class="room-title">Ø±ÙˆÙ… ØµÙˆØªÙŠ â€“ Ø´Ø§Øª Ø£Ø¨Ùˆ Ø£Ù…ÙŠØ±</div>
        <div id="roomSubtitle" class="room-sub">Cyberpunk â€“ Ø´Ø§Øª + Ù…Ø§ÙŠÙƒØ§Øª</div>
      </div>

      <div id="onlinePill" class="pill">
        <span class="pill-dot"></span>
        <span id="onlineText">Ù…ØªØµÙ„ 1</span>
        <i class="fa-solid fa-signal"></i>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø§ÙŠÙƒØ§Øª -->
    <div class="mics-block">
      <div class="mics-top-row">
        <div class="mics-label">
          <i class="fa-solid fa-microphone-lines"></i>
          <span>Ø§Ù„Ù…Ø§ÙŠÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
        </div>
        <span>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§ÙŠÙƒ Ù„Ù„Ø­Ø¬Ø² / Ø§Ù„ØªØ±Ùƒ</span>
      </div>

      <div class="mics-row">
        <div class="mic-slot">
          <button class="mic-circle" data-slot="1" onclick="handleMicSlotClick(1)">
            <span><i class="fa-solid fa-microphone"></i></span>
          </button>
          <div class="mic-name" id="mic-name-1">Ø¶ÙŠÙ</div>
        </div>
        <div class="mic-slot">
          <button class="mic-circle" data-slot="2" onclick="handleMicSlotClick(2)">
            <span><i class="fa-solid fa-microphone"></i></span>
          </button>
          <div class="mic-name" id="mic-name-2">Ø¶ÙŠÙ</div>
        </div>
        <div class="mic-slot">
          <button class="mic-circle" data-slot="3" onclick="handleMicSlotClick(3)">
            <span><i class="fa-solid fa-microphone"></i></span>
          </button>
          <div class="mic-name" id="mic-name-3">Ø¶ÙŠÙ</div>
        </div>
        <div class="mic-slot">
          <button class="mic-circle" data-slot="4" onclick="handleMicSlotClick(4)">
            <span><i class="fa-solid fa-microphone"></i></span>
          </button>
          <div class="mic-name" id="mic-name-4">Ø¶ÙŠÙ</div>
        </div>
        <div class="mic-slot">
          <button class="mic-circle" data-slot="5" onclick="handleMicSlotClick(5)">
            <span><i class="fa-solid fa-microphone"></i></span>
          </button>
          <div class="mic-name" id="mic-name-5">Ø¶ÙŠÙ</div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø´Ø§Øª + Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† -->
    <div class="main-columns">
      <!-- Ø§Ù„Ø´Ø§Øª -->
      <div class="panel">
        <div class="panel-header">
          <span><i class="fa-solid fa-comments"></i> Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±ÙˆÙ…</span>
          <span style="font-size:11px;color:#9ca3af;">ØªØ¸Ù‡Ø± Ù„Ù„ÙƒÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±ÙˆÙ…</span>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-row">
          <input id="chatInput" type="text"
                 placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ¸Ù‡Ø± Ù„ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø±ÙˆÙ…...">
          <button class="send-btn" onclick="sendRoomMessage()">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>

      <!-- Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† -->
      <div class="panel">
        <div class="panel-header">
          <span><i class="fa-solid fa-users"></i> Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ø¨Ø§Ù„Ø±ÙˆÙ…</span>
          <span id="membersCount" style="font-size:11px;color:#9ca3af;">0 Ø£Ø¹Ø¶Ø§Ø¡</span>
        </div>
        <div id="participantsList" class="participants-list"></div>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ + Ø§Ù„Ù„ÙˆØ¬ -->
    <div class="call-panel">
      <div class="call-steps-title">
        <i class="fa-solid fa-wave-square"></i>
        <span>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ (WebRTC)</span>
      </div>

      <div class="call-row">
        <span class="step-label">Ù¡ â€“ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ (Ø¹Ù†Ø¯ ÙƒÙ„ Ø´Ø®Øµ)</span>
        <button class="btn-sm btn-mic" onclick="startMic()">
          <i class="fa-solid fa-microphone"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ
        </button>
        <span id="micReadyText" class="hint-ok" style="display:none;">
          âœ” Ø§Ù„Ù…Ø§ÙŠÙƒ Ø§Ø´ØªØºÙ„ØŒ ÙƒÙ…Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ù¢.
        </span>
      </div>

      <div class="call-row">
        <span class="step-label">Ù¢ â€“ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„)</span>
        <button class="btn-sm btn-create" onclick="createRoomCall()">
          âš¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„)
        </button>
      </div>

      <div class="call-row">
        <span class="step-label">Ù£ â€“ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ)</span>
        <button class="btn-sm btn-join" onclick="joinRoomCall()">
          ğŸ”— Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ)
        </button>
      </div>

      <div class="call-row">
        <span class="step-label">Ù¤ â€“ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„</span>
        <button class="btn-sm btn-hang" onclick="hangUpCall()">
          âœ– Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
        </button>
      </div>

      <div style="margin-top:6px;font-size:11px;color:#9ca3af;">
        Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø®ÙÙ„Ù‘ÙŠ ØµØ¯ÙŠÙ‚Ùƒ ÙŠØ¶ØºØ· (Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØµØ§Ù„).  
        Ø§Ù„ØµÙˆØª ÙŠØ·Ù„Ø¹ Ù…Ù† Ù‡Ù†Ø§:
      </div>
      <audio id="remoteAudio" controls></audio>

      <div class="log-title">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù„ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡):</div>
      <textarea id="logBox" class="log-box" readonly></textarea>

      <div class="room-id-pill">
        <span>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© Ø§Ù„ØµÙˆØªÙŠØ© (Ø«Ø§Ø¨Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±ÙˆÙ…):</span>
        <code id="roomIdLabel"></code>
      </div>
    </div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyBPapPdivEQO1UPqQdCRTBI6ct8KZDtqyw",
    authDomain: "sjfie-bed64.firebaseapp.com",
    projectId: "sjfie-bed64",
    storageBucket: "sjfie-bed64.firebasestorage.app",
    messagingSenderId: "67450727104",
    appId: "1:67450727104:web:4d271f44bab9740571db25"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ø·ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· =====
  const urlParams = new URLSearchParams(window.location.search);
  const roomIdFromUrl  = urlParams.get("roomId")   || "voice_room_cyberpunk_1";
  const roomNameFromUrl= urlParams.get("roomName") || "Ø±ÙˆÙ… ØµÙˆØªÙŠ â€“ Ø´Ø§Øª Ø£Ø¨Ùˆ Ø£Ù…ÙŠØ±";
  const userNameFromUrl= urlParams.get("user")     || "Ø¶ÙŠÙ";

  document.getElementById("roomTitle").textContent    = roomNameFromUrl;
  document.getElementById("roomSubtitle").textContent = "Cyberpunk â€“ " + roomNameFromUrl;
  document.getElementById("roomIdLabel").textContent  = roomIdFromUrl;

  const localName = localStorage.getItem("chat_display_name") || userNameFromUrl;
  const myName = localName || "Ø¶ÙŠÙ";
  const myUid = (function () {
    let uid = localStorage.getItem("voice_uid");
    if (!uid) {
      uid = "v_" + Date.now() + "_" + Math.floor(Math.random() * 999999);
      localStorage.setItem("voice_uid", uid);
    }
    return uid;
  })();

  document.getElementById("onlineText").textContent = "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";

  // ===== Ø­Ø¶ÙˆØ± Ø§Ù„Ø±ÙˆÙ… =====
  const presenceRef      = db.collection("voiceRoomPresence").doc(roomIdFromUrl);
  const presenceUsersRef = presenceRef.collection("users");

  presenceUsersRef.doc(myUid).set({
    uid: myUid,
    name: myName,
    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).catch(() => {});

  window.addEventListener("beforeunload", () => {
    presenceUsersRef.doc(myUid).delete().catch(() => {});
  });

  presenceUsersRef.orderBy("joinedAt", "asc").onSnapshot(snap => {
    const listEl = document.getElementById("participantsList");
    listEl.innerHTML = "";
    let count = 0;
    snap.forEach(doc => {
      count++;
      const u = doc.data();
      const row = document.createElement("div");
      row.className = "participant-row";
      row.innerHTML = `
        <div class="participant-name">
          <i class="fa-solid fa-signal"></i>
          <span>${u.name || "Ù…Ø³ØªØ®Ø¯Ù…"}</span>
        </div>
        <span class="badge-pill">${u.uid === myUid ? "Ø£Ù†Øª" : "Ù…ØªØµÙ„"}</span>
      `;
      listEl.appendChild(row);
    });
    document.getElementById("membersCount").textContent = count + " Ù…ØªØµÙ„";
  });

  // ===== Ø´Ø§Øª Ø§Ù„Ø±ÙˆÙ… =====
  const chatRef = db.collection("voiceRoomMessages")
                    .doc(roomIdFromUrl)
                    .collection("messages");

  chatRef.orderBy("timestamp", "asc").onSnapshot(snap => {
    const box = document.getElementById("chatMessages");
    box.innerHTML = "";
    snap.forEach(doc => {
      const m = doc.data();
      const div = document.createElement("div");
      div.className = "chat-row";
      const time = m.timestamp
        ? m.timestamp.toDate().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})
        : "";
      div.innerHTML = `
        <div class="chat-meta">
          <strong>${m.sender || "Ù…Ø³ØªØ®Ø¯Ù…"}</strong>
          <span>${time}</span>
        </div>
        <div class="chat-text">${m.text || ""}</div>
      `;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  });

  function sendRoomMessage() {
    const input = document.getElementById("chatInput");
    const text = (input.value || "").trim();
    if (!text) return;
    chatRef.add({
      sender: myName,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value = "";
  }

  document.getElementById("chatInput").addEventListener("keypress", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendRoomMessage();
    }
  });

  // ===== Ø§Ù„Ù…Ø§ÙŠÙƒØ§Øª (UI + Ø±Ø¨Ø· Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ) =====
  let currentMicSlot = null;

  async function handleMicSlotClick(slot) {
    const micButtons = document.querySelectorAll(".mic-circle");
    const labels = [];
    for (let i = 1; i <= 5; i++) {
      labels[i] = document.getElementById("mic-name-" + i);
    }

    const btn = document.querySelector('.mic-circle[data-slot="' + slot + '"]');
    if (!btn) return;

    // Ù„Ùˆ ÙƒÙ†Øª Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø§ÙŠÙƒ â€“ Ø£ØªØ±ÙƒÙ‡
    if (currentMicSlot === slot) {
      btn.classList.remove("mic-active");
      labels[slot].textContent = "Ø¶ÙŠÙ";
      currentMicSlot = null;
      return;
    }

    // Ø­Ø±Ø± Ø§Ù„Ù…Ø§ÙŠÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    if (currentMicSlot !== null) {
      const oldBtn = document.querySelector('.mic-circle[data-slot="' + currentMicSlot + '"]');
      if (oldBtn) oldBtn.classList.remove("mic-active");
      if (labels[currentMicSlot]) labels[currentMicSlot].textContent = "Ø¶ÙŠÙ";
    }

    // Ø­Ø¬Ø² Ø§Ù„Ù…Ø§ÙŠÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    currentMicSlot = slot;
    btn.classList.add("mic-active");
    labels[slot].textContent = myName || "Ø£Ù†Øª";

    // ğŸ”Š Ù‡Ù†Ø§ Ù†Ø±Ø¨Ø· Ø§Ù„Ù…Ø§ÙŠÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ â€“ Ù†Ø¶Ù…Ù† Ø£Ù†Ù‡ ÙŠØ´ØªØºÙ„
    try {
      await startMic();
    } catch (e) {
      // Ù„Ùˆ ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒØŒ Ù†Ø±Ø¬Ø¹ Ù†Ø­Ø±Ø± Ø§Ù„Ù…Ø§ÙŠÙƒ UI
      btn.classList.remove("mic-active");
      labels[slot].textContent = "Ø¶ÙŠÙ";
      currentMicSlot = null;
    }
  }

  // ===== WebRTC + TURN/STUN =====
  const iceServers = [
    { urls: "stun:stun.relay.metered.ca:80" },
    {
      urls: "turn:global.relay.metered.ca:80",
      username: "298f82b9f76dd02a4339d78d",
      credential: "oe03DDgXofO1Pxs5",
    },
    {
      urls: "turn:global.relay.metered.ca:80?transport=tcp",
      username: "298f82b9f76dd02a4339d78d",
      credential: "oe03DDgXofO1Pxs5",
    },
    {
      urls: "turn:global.relay.metered.ca:443",
      username: "298f82b9f76dd02a4339d78d",
      credential: "oe03DDgXofO1Pxs5",
    },
    {
      urls: "turn:global.relay.metered.ca:443?transport=tcp",
      username: "298f82b9f76dd02a4339d78d",
      credential: "oe03DDgXofO1Pxs5",
    }
  ];

  let pc = null;
  let localStream = null;
  let remoteStream = null;
  let roomDocRef = null;
  let callerCandidatesRef = null;
  let calleeCandidatesRef = null;
  let roomUnsub = null;
  let callerIceUnsub = null;
  let calleeIceUnsub = null;
  let pendingCandidates = [];

  const logBox = document.getElementById("logBox");

  function log(msg) {
    const time = new Date().toLocaleTimeString("ar-IQ", {hour12:false});
    logBox.value += `[${time}] ${msg}\n`;
    logBox.scrollTop = logBox.scrollHeight;
    console.log(msg);
  }

  function createPeerConnection() {
    pc = new RTCPeerConnection({ iceServers });

    pc.onicecandidate = event => {
      if (event.candidate && roomDocRef && callerCandidatesRef && calleeCandidatesRef) {
        const candidateData = event.candidate.toJSON();
        if (isCaller) {
          callerCandidatesRef.add(candidateData);
          log("Caller ICE candidate -> Firestore.");
        } else {
          calleeCandidatesRef.add(candidateData);
          log("Callee ICE candidate -> Firestore.");
        }
      }
    };

    pc.ontrack = event => {
      if (!remoteStream) {
        remoteStream = new MediaStream();
        document.getElementById("remoteAudio").srcObject = remoteStream;
      }
      event.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
      log("ontrack: remote audio streams received.");
    };

    pc.oniceconnectionstatechange = () => {
      log("iceConnectionState: " + pc.iceConnectionState);
    };
    pc.onconnectionstatechange = () => {
      log("connectionState: " + pc.connectionState);
    };
  }

  // ===== ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ =====
  async function startMic() {
    try {
      if (!localStream) {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      }
      document.getElementById("micReadyText").style.display = "inline-block";
      log("Microphone started successfully.");
    } catch (err) {
      log("Error starting microphone: " + err);
      alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†.");
      throw err;
    }
  }

  let isCaller = false;

  // ===== Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„) =====
  async function createRoomCall() {
    try {
      isCaller = true;
      await ensureMicStream();
      createPeerConnection();

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      roomDocRef = db.collection("webrtcRooms").doc(roomIdFromUrl);
      callerCandidatesRef = roomDocRef.collection("callerCandidates");
      calleeCandidatesRef = roomDocRef.collection("calleeCandidates");

      await callerCandidatesRef.get().then(s => s.forEach(d => d.ref.delete())).catch(()=>{});
      await calleeCandidatesRef.get().then(s => s.forEach(d => d.ref.delete())).catch(()=>{});
      await roomDocRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomDocRef.set({ offer: { type: offer.type, sdp: offer.sdp } }, { merge: true });

      log("Room created with offer, waiting for answer...");

      roomUnsub = roomDocRef.onSnapshot(async snapshot => {
        const data = snapshot.data();
        if (!pc.currentRemoteDescription && data && data.answer) {
          const answer = new RTCSessionDescription(data.answer);
          await pc.setRemoteDescription(answer);
          log("Room updated with answer.");
          pendingCandidates.forEach(c => {
            pc.addIceCandidate(new RTCIceCandidate(c)).catch(err=>{
              log("Error add pending ICE (caller): " + err);
            });
          });
          pendingCandidates = [];
        }
      });

      calleeIceUnsub = calleeCandidatesRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            const data = change.doc.data();
            handleIncomingCandidate(data, "caller");
          }
        });
      });

    } catch (err) {
      log("Error in createRoomCall: " + err);
    }
  }

  // ===== Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ) =====
  async function joinRoomCall() {
    try {
      isCaller = false;
      await ensureMicStream();
      createPeerConnection();

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      roomDocRef = db.collection("webrtcRooms").doc(roomIdFromUrl);
      callerCandidatesRef = roomDocRef.collection("callerCandidates");
      calleeCandidatesRef = roomDocRef.collection("calleeCandidates");

      const roomSnapshot = await roomDocRef.get();
      if (!roomSnapshot.exists || !roomSnapshot.data().offer) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ù…Ù†Ø´Ø£ Ø¨Ø¹Ø¯. Ø®Ù„ÙŠ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¶ØºØ· (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„).");
        return;
      }

      const offer = roomSnapshot.data().offer;
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      log("Offer loaded from Firestore, creating answer...");

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await roomDocRef.set({ answer: { type: answer.type, sdp: answer.sdp } }, { merge: true });

      callerIceUnsub = callerCandidatesRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            const data = change.doc.data();
            handleIncomingCandidate(data, "callee");
          }
        });
      });

    } catch (err) {
      log("Error in joinRoomCall: " + err);
    }
  }

  function handleIncomingCandidate(candidateData, role) {
    log(`New ${role} ICE candidate from Firestore.`);
    if (!candidateData) return;

    if (pc && pc.remoteDescription) {
      pc.addIceCandidate(new RTCIceCandidate(candidateData)).catch(err => {
        log(`Error addIceCandidate (${role}): ` + err);
      });
    } else {
      pendingCandidates.push(candidateData);
    }
  }

  async function ensureMicStream() {
    if (!localStream) {
      await startMic();
    }
  }

  // ===== Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ =====
  async function hangUpCall() {
    log("--- hangUp() called ---");

    if (callerIceUnsub) callerIceUnsub();
    if (calleeIceUnsub) calleeIceUnsub();
    if (roomUnsub) roomUnsub();

    callerIceUnsub = calleeIceUnsub = roomUnsub = null;
    pendingCandidates = [];

    if (pc) {
      pc.getSenders().forEach(s => s.track && s.track.stop());
      pc.close();
      pc = null;
    }

    if (remoteStream) {
      remoteStream.getTracks().forEach(t => t.stop());
      remoteStream = null;
      document.getElementById("remoteAudio").srcObject = null;
    }

    if (roomDocRef) {
      try {
        await roomDocRef.collection("callerCandidates").get().then(s => s.forEach(d => d.ref.delete()));
        await roomDocRef.collection("calleeCandidates").get().then(s => s.forEach(d => d.ref.delete()));
      } catch (e) {}
    }

    log("Call ended.");
  }

  function goBackToMain() {
    window.location.href = "index.html";
  }
</script>

</body>
</html>
