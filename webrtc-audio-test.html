<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ¬Ø±Ø¨Ø© ØµÙˆØª WebRTC â€“ Ø´Ø§Øª Ø£Ø¨Ùˆ Ø£Ù…ÙŠØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #020617 100%);
      color: #e5e7eb;
      direction: rtl;
    }
    .page {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 18px 16px 20px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
    }
    h1 { font-size: 20px; margin: 0 0 4px; }
    .subtitle { font-size: 12px; color: #9ca3af; margin-bottom: 14px; }
    .section { margin-top: 14px; padding-top: 10px; border-top: 1px solid rgba(55, 65, 81, 0.7); }
    .label { font-size: 13px; margin-bottom: 6px; font-weight: 600; }
    .btn-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 0 15px rgba(34, 197, 94, 0.8);
    }
    button.secondary {
      background: linear-gradient(135deg, #0ea5e9, #0369a1);
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.7);
    }
    button.danger {
      background: linear-gradient(135deg, #f97316, #b91c1c);
      box-shadow: 0 0 15px rgba(248, 113, 113, 0.8);
    }
    button:disabled { opacity: 0.4; cursor: default; box-shadow: none; }
    .status { font-size: 12px; color: #a5b4fc; margin-top: 4px; min-height: 18px; }
    .log {
      margin-top: 8px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      padding: 8px 10px;
      max-height: 160px;
      overflow-y: auto;
      white-space: pre-wrap;
      direction: ltr;
      text-align: left;
    }
    .audio-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.7);
      font-size: 12px;
    }
    .audio-box p { margin: 0 0 6px; font-size: 12px; color: #cbd5f5; }
    audio { width: 100%; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(56, 189, 248, 0.7);
      color: #7dd3fc;
    }
    .badge span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }
  </style>
</head>
<body>

<div class="page">
  <h1>ØªØ¬Ø±Ø¨Ø© ØµÙˆØª WebRTC</h1>
  <div class="subtitle">
    Ø´Ø®ØµÙŠÙ† ÙÙ‚Ø·: ÙˆØ§Ø­Ø¯ ÙŠØ¶ØºØ· <b>Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„</b> ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ <b>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØµØ§Ù„</b> â€“ Ø¹Ø¨Ø± Firebase.
  </div>

  <div class="section">
    <div class="label">Ù¡ â€“ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ (Ø¹Ù†Ø¯ ÙƒÙ„ Ø´Ø®Øµ)</div>
    <div class="btn-row">
      <button id="btnStartMic" onclick="startMic()">
        ğŸ™ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ
      </button>
    </div>
    <div id="micStatus" class="status"></div>
  </div>

  <div class="section">
    <div class="label">Ù¢ â€“ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„</div>
    <div class="btn-row">
      <button id="btnCreate" onclick="createRoom()" disabled>
        âš¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„)
      </button>
      <button id="btnJoin" class="secondary" onclick="joinRoom()" disabled>
        ğŸ”— Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ)
      </button>
      <button id="btnHangup" class="danger" onclick="hangUp()" disabled>
        âŒ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
      </button>
    </div>
    <div id="roomStatus" class="status"></div>
  </div>

  <div class="section">
    <div class="label">Ù£ â€“ Ø§Ù„ØµÙˆØª</div>
    <div class="audio-box">
      <p>ğŸ”Š ØµÙˆØª ØµØ¯ÙŠÙ‚Ùƒ (remote):</p>
      <audio id="remoteAudio" autoplay controls></audio>
    </div>
  </div>

  <div class="section">
    <div class="label">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù„ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)</div>
    <div id="log" class="log"></div>
  </div>

  <div style="margin-top:10px; font-size:11px; color:#9ca3af;">
    <span class="badge">
      <span class="dot"></span>
      <span>roomId Ø«Ø§Ø¨Øª: <b>audio_room_test_1</b></span>
    </span>
    <div style="margin-top:4px;">
      ÙƒÙ„Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ÙŠÙ† Ù„Ø§Ø²Ù… ÙŠÙØªØ­ÙˆÙ† <b>Ù†ÙØ³ Ø§Ù„Ø±Ø§Ø¨Ø·</b> Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŒ ÙˆØ§Ø­Ø¯ ÙŠØ³ÙˆÙŠ Ø¥Ù†Ø´Ø§Ø¡ØŒ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù†Ø¶Ù…Ø§Ù….
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBPapPdivEQO1UPqQdCRTBI6ct8KZDtqyw",
    authDomain: "sjfie-bed64.firebaseapp.com",
    projectId: "sjfie-bed64",
    storageBucket: "sjfie-bed64.firebasestorage.app",
    messagingSenderId: "67450727104",
    appId: "1:67450727104:web:4d271f44bab9740571db25"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const ROOM_ID = "audio_room_test_1";

  const logBox       = document.getElementById("log");
  const micStatus    = document.getElementById("micStatus");
  const roomStatus   = document.getElementById("roomStatus");
  const remoteAudio  = document.getElementById("remoteAudio");
  const btnStartMic  = document.getElementById("btnStartMic");
  const btnCreate    = document.getElementById("btnCreate");
  const btnJoin      = document.getElementById("btnJoin");
  const btnHangup    = document.getElementById("btnHangup");

  const servers = {
    iceServers: [
      { urls: [ "stun:stun.l.google.com:19302" ] }
    ]
  };

  let pc = null;
  let localStream = null;
  let remoteStream = null;

  let roomRef = null;
  let callerCandidatesCollection = null;
  let calleeCandidatesCollection = null;

  function addLog(msg) {
    console.log(msg);
    if (!logBox) return;
    const time = new Date().toLocaleTimeString("ar-IQ", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    logBox.textContent += `[${time}] ${msg}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  async function startMic() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      micStatus.textContent = "âœ… Ø§Ù„Ù…Ø§ÙŠÙƒ Ø§Ø´ØªØºÙ„ØŒ ÙƒÙ…Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ù¢ (Ø¥Ù†Ø´Ø§Ø¡ / Ø§Ù†Ø¶Ù…Ø§Ù…).";
      btnCreate.disabled = false;
      btnJoin.disabled = false;
      addLog("localStream ready (audio).");
    } catch (e) {
      micStatus.textContent = "âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ. ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.";
      addLog("Error getUserMedia: " + e.message);
    }
  }

  function createPeerConnection() {
    pc = new RTCPeerConnection(servers);
    addLog("RTCPeerConnection created.");

    if (localStream) {
      localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
      });
      addLog("Local audio track(s) added.");
    }

    remoteStream = new MediaStream();
    remoteAudio.srcObject = remoteStream;

    pc.ontrack = (event) => {
      addLog("ontrack: remote audio streams received.");
      const incomingStream = event.streams[0];
      incomingStream.getAudioTracks().forEach(track => {
        remoteStream.addTrack(track);
      });

      remoteAudio.play().catch(err => {
        addLog("Autoplay blocked, user must press play on audio element. " + err.message);
      });
    };

    pc.oniceconnectionstatechange = () => {
      addLog("iceConnectionState: " + pc.iceConnectionState);
      if (pc.iceConnectionState === "connected") {
        roomStatus.textContent = "âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ Ø´ØºØ§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø²ÙŠÙ†.";
      } else if (pc.iceConnectionState === "failed") {
        roomStatus.textContent = "âŒ Ø§Ù„Ø§ØªØµØ§Ù„ ÙØ´Ù„ (ØºØ§Ù„Ø¨Ø§Ù‹ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø´Ø¨ÙƒØ© / NAT).";
      }
    };

    pc.onconnectionstatechange = () => {
      addLog("connectionState: " + pc.connectionState);
    };
  }

  // Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„
  async function createRoom() {
    roomStatus.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©...";
    addLog("--- createRoom() called ---");

    createPeerConnection();

    roomRef = db.collection("webrtcRooms").doc(ROOM_ID);
    callerCandidatesCollection = roomRef.collection("callerCandidates");
    calleeCandidatesCollection = roomRef.collection("calleeCandidates");

    // Ø­ÙØ¸ ICE Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„
    pc.onicecandidate = async (event) => {
      if (event.candidate) {
        addLog("Caller ICE candidate -> Firestore.");
        await callerCandidatesCollection.add(event.candidate.toJSON());
      } else {
        addLog("Caller ICE gathering complete.");
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    addLog("Offer created & setLocalDescription.");

    const roomWithOffer = { offer: { type: offer.type, sdp: offer.sdp } };
    await roomRef.set(roomWithOffer);
    addLog("Room document created with offer.");

    roomStatus.textContent = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„. Ø®Ù„ÙŠ ØµØ¯ÙŠÙ‚Ùƒ ÙŠØ¶ØºØ· (Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØµØ§Ù„).";

    // Ù†Ù†ØªØ¸Ø± Ø§Ù„Ù€ answer ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ù†Ø±Ø¨Ø· Ø§Ù„Ù€ ICE Ù…Ø§Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ
    roomRef.onSnapshot(async snap => {
      const data = snap.data();
      if (!pc.currentRemoteDescription && data && data.answer) {
        addLog("Got answer from callee, setRemoteDescription.");
        const answer = new RTCSessionDescription(data.answer);
        await pc.setRemoteDescription(answer);

        // Ø§Ù„Ø¢Ù† ÙÙ‚Ø· Ù†Ø³Ù…Ø­ Ø¨Ø¥Ø¶Ø§ÙØ© ICE Ù…Ø§Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ
        calleeCandidatesCollection.onSnapshot(snapshot => {
          snapshot.docChanges().forEach(async change => {
            if (change.type === "added") {
              const candidateData = change.doc.data();
              addLog("New callee ICE candidate from Firestore (after remoteDescription).");
              try {
                await pc.addIceCandidate(new RTCIceCandidate(candidateData));
              } catch (e) {
                addLog("Error addIceCandidate (callee): " + e.message);
              }
            }
          });
        });
      }
    });

    btnCreate.disabled = true;
    btnJoin.disabled = true;
    btnHangup.disabled = false;
  }

  // Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ
  async function joinRoom() {
    roomStatus.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©...";
    addLog("--- joinRoom() called ---");

    const roomSnapshot = await db.collection("webrtcRooms").doc(ROOM_ID).get();
    if (!roomSnapshot.exists) {
      roomStatus.textContent = "âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©. Ø®Ù„ÙŠÙƒ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ®Ù„ÙŠ ØµØ¯ÙŠÙ‚Ùƒ ÙŠØ¶ØºØ· (Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„) Ø£ÙˆÙ„Ø§Ù‹.";
      addLog("Room not found.");
      return;
    }

    roomRef = roomSnapshot.ref;
    callerCandidatesCollection = roomRef.collection("callerCandidates");
    calleeCandidatesCollection = roomRef.collection("calleeCandidates");

    createPeerConnection();

    // Ø­ÙØ¸ ICE Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ
    pc.onicecandidate = async (event) => {
      if (event.candidate) {
        addLog("Callee ICE candidate -> Firestore.");
        await calleeCandidatesCollection.add(event.candidate.toJSON());
      } else {
        addLog("Callee ICE gathering complete.");
      }
    };

    const roomData = roomSnapshot.data();
    const offer = roomData.offer;
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    addLog("Offer set as remote description.");

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    addLog("Answer created & setLocalDescription.");

    const roomWithAnswer = { answer: { type: answer.type, sdp: answer.sdp } };
    await roomRef.update(roomWithAnswer);
    addLog("Room updated with answer.");

    // Ø¨Ø¹Ø¯ Ù…Ø§ ØµØ§Ø±Øª remoteDescription Ù…ØªØ¶Ø¨Ø·Ø©ØŒ Ù†Ø¶ÙŠÙ ICE Ù…Ø§Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„
    callerCandidatesCollection.onSnapshot(snapshot => {
      snapshot.docChanges().forEach(async change => {
        if (change.type === "added") {
          addLog("New caller ICE candidate from Firestore (after remoteDescription).");
          const data = change.doc.data();
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data));
          } catch (e) {
            addLog("Error addIceCandidate (caller): " + e.message);
          }
        }
      });
    });

    btnCreate.disabled = true;
    btnJoin.disabled = true;
    btnHangup.disabled = false;
    roomStatus.textContent = "ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…. Ø§Ù†ØªØ¸Ø± Ù„Ø­ÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„...";
  }

  async function hangUp() {
    addLog("--- hangUp() called ---");
    roomStatus.textContent = "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„.";

    if (pc) {
      pc.close();
      pc = null;
    }

    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
    }

    if (roomRef) {
      const callerCandidates = await callerCandidatesCollection.get();
      callerCandidates.forEach(doc => doc.ref.delete());
      const calleeCandidates = await calleeCandidatesCollection.get();
      calleeCandidates.forEach(doc => doc.ref.delete());
    }

    btnCreate.disabled = false;
    btnJoin.disabled = false;
    btnHangup.disabled = true;
  }

  window.startMic = startMic;
  window.createRoom = createRoom;
  window.joinRoom = joinRoom;
  window.hangUp = hangUp;
</script>

</body>
</html>
